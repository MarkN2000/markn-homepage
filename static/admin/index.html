<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
</head>
<body>
  <div id="nc-root"></div>

  <script src="https://unpkg.com/decap-cms@3.6.3/dist/decap-cms.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

  <script>
    // manual_init を true に設定
    window.CMS_MANUAL_INIT = true;

    function attemptCMSInitialization() {
      // window.CMS と window.jsyaml が利用可能か確認
      if (window.CMS && typeof window.CMS.init === 'function' && window.jsyaml) {
        console.log("CMS and jsyaml are ready. Fetching config...");
        
        // nc-root要素が確実に存在するか確認（appendChildエラー対策）
        const ncRoot = document.getElementById('nc-root');
        if (!ncRoot) {
          console.error("#nc-root element not found. CMS cannot be initialized.");
          // 必要であればユーザーにエラー表示
          return;
        }
        console.log("#nc-root element found:", ncRoot);

        fetch('config.yml') // adminディレクトリからの相対パス
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to fetch config.yml: ' + response.statusText);
            }
            return response.text();
          })
          .then(yamlText => {
            const config = jsyaml.load(yamlText);
            console.log("Manually loaded config for CMS.init():", JSON.parse(JSON.stringify(config)));
            
            try {
              window.CMS.init({ config });
              console.log("CMS.init() called successfully.");

              // この時点でCMSのUIが #nc-root にレンダリングされ始めるはず
              // 認証フローに進むための準備が整う

            } catch (e) {
              console.error("Error during CMS.init() call:", e);
              if (ncRoot) {
                ncRoot.innerHTML = 'Error calling CMS.init(): ' + e.message;
              }
            }
          })
          .catch(error => {
            console.error('Error during manual CMS initialization (fetch/parse config):', error);
            if (ncRoot) {
              ncRoot.innerHTML = 'Error loading or parsing config.yml: ' + error.message;
            }
          });
      } else {
        // CMSオブジェクトまたはjsyamlがまだ準備できていなければ、少し待って再試行
        console.log("CMS or jsyaml not ready yet, retrying in 200ms...");
        setTimeout(attemptCMSInitialization, 200); // 再試行間隔を少し長くする
      }
    }

    // DOMの準備完了を待たずに初期化処理の呼び出しを開始する
    // ライブラリが読み込まれ次第、attemptCMSInitialization内のチェックで進むはず
    attemptCMSInitialization();
  </script>
</body>
</html>